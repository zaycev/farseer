# -*- coding: utf-8 -*-import timeimport threadingimport multiprocessingimport loggingimport tracebackclass Behavior(object):	PROC = 0	THREAD = 1class Service(object):	name = "service"	behavior_mode = Behavior.THREAD	logger_cls = None	main_loop_timeout = 5	send_timeout = 10	receive_timeout = 2	def __init__(self, *args, **kwargs):		self.mailbox = self.__class__.Mailbox(self, **kwargs)		self.logger_cls = logging.getLogger(self.name)	def run(self):		if self.behavior_mode == Behavior.PROC:			self.unit = multiprocessing.Process(				name=self.name,				target=lambda: self.__class__.service_loop(self)			)		elif self.behavior_mode == Behavior.THREAD:			self.unit = threading.Thread(				name=self.name,				target=lambda: self.__class__.service_loop(self)			)		self.init_mailbox(self.mailbox)		self.unit.daemon = True		self.unit.start()	class Mailbox(object):		def __init__(self, owner, **kwargs):			self.input_queue = None			self.output_queue = None			self.keeper = None			self.owner = owner	def send_task(self, task):		if self.mailbox.output_queue:			while self.mailbox.output_queue.full():				time.sleep(self.send_timeout)			try:				self.mailbox.output_queue.put(task,					False, self.send_timeout)			except:				time.sleep(self.send_timeout)			finally:				pass	def receive_task(self):		task = None		try:			task = self.mailbox.input_queue.get(False,				self.receive_timeout)		finally:			return task	def task_done(self):		self.mailbox.input_queue.task_done()	def rollback(self, task):		if self.mailbox.input_queue:			while self.mailbox.input_queue.full():				time.sleep(self.send_timeout * 2)			try:				self.mailbox.input_queue.put(task,					False, self.send_timeout * 2)			except:				time.sleep(self.send_timeout * 2)			finally:				pass	def keep_task(self, task):		if self.mailbox.keeper:			try:				self.mailbox.keeper.put(task,					False, self.send_timeout * 2)			finally:				pass	def service_loop(self):		raise NotImplementedError()	def target(self, task, **kwargs):		raise NotImplementedError()	def init_mailbox(self, mailbox, **kwargs):		pass	def log(self, message):		self.logger_cls.debug(message)import sysclass Worker(Service):	name = "worker"	def service_loop(self):		if self.behavior_mode == Behavior.PROC:			sys.argv[0] = "python " + self.name		while True:			task = None			try:				task = self.receive_task()				if not task:					time.sleep(self.main_loop_timeout)				else:					result = self.target(task)					for new_task in result:						if new_task.is_correct():							self.keep_task(new_task)							self.send_task(new_task)			except Exception:				log = [task, traceback.format_exc()]				self.log("main loop error while handling task\n{0}\n{1}".format(*log))				if task: self.rollback(task)	def target(self, task):		return [task]